## SOA Client 模块 ##

node SOA 客户端，支持`WebApi`,`IP直连`,`serviceMesh(见 tips)`的访问方式。

:::tip
可在 `app.config.js` 中全局指定以下参数，作用如下：
- `SOA.Timeout` [<number\>](###) 应用自定义指定响应超时时间。
- `SOA.HandleServiceErrorManually`  [<boolean\>](###) 默认 `false` , 当指定该值为 `true` 时调用方会收到soa返回的所有内容，由调用方处理判断错误码。
- 当前SDK 仅提供`WebApi`和`IP直连`的API,当应用接入这两种API(二选一)，同时，在captain对应环境下开启`serviceMesh`开关并发布之后，会默认通过`serviceMesh`访问SOA 服务(无需修改代码)。
:::

## 使用 ##

```
const {SoaClientAgent} = require('@ctrip/node-vampire-standard-soa-client');
```

## 接口

### SoaClientAgent(serviceId, clientOptions)[method](invokeOptions)
### SoaClientAgent(clientOptions)[method](invokeOptions)
创建一个新的 SOA 客户端 

- `serviceId` <string> Service ID ,[如何查看服务的Service ID](http://gov.soa.fx.ctripcorp.com/service/service-info/16264?env=pro#service_info)
- `options` [<Object\>](###) SOA Client 的初始化配置
	- `serviceCode` | `serviceId` [<string\>](###) 服务号或服务 `ID` 两者选一
    - `originalResponse` [<boolean\>](###) 可设置返回请求的原始响应报文,包含:{headers,body,statusCode}。默认为`false`
	- `soaClientType` [<enum\>](###) 选择客户端类型(`WebApi`,`IP 直连`)。此项不填时，默认直连
	- `format` [<string\>](###) 指定服务端返回数据格式，可选。`bjjson` 或 `json`，默认 `json`.同[SOA客户端指定服务端Json序列化器](http://conf.ctripcorp.com/pages/viewpage.action?pageId=167783872)

	:::tip
	- 初始化时指定参数 `format` 值。*注意：若 JAVA 服务端没有设置 `default-json-format`，那么 /json/XX 和 /bjjson/XXX 返回的都是 `bjjson`;如果设置了 `default-json-format`,那么 /json/XXX 返回的是 `json`,/bjjson/XXX返回的是 `bjjson`
	- 上述方式无效时,通过 `invoke` 方法的 `query` 参数追加：`{jsonType: 'bjjson/ssjson'}` 的方式指定
	:::
    - `agent` [<Object\>](###) 自定义[http.Agent](https://nodejs.org/dist/latest-v10.x/docs/api/http.html#http_class_http_agent) 覆盖默认的agent
	- `serviceTimeout` [<number\>](###) 指定该实例下所有请求超时时间，可选。
	- `soaServerUrl` [<string\>](###) 通过指定的 `URL` 请求服务，可选，一般在请求本地服务时可指定。
	- `subEnv` [<string\>](###) 指定 `subEnv` ，可选,仅在fws/fat环境需要指定服务方所在的 `subEnv`时使用。不建议用户自己指定子环境，建议将应用发布到对应的子环境下，此时按照`子环境优先原则`默认优先访问当前子环境下的服务实例。
- `method` [<string\>](###) 方法名
- `invokeOptions` [<Object\>](###) 向 SOA 服务端指定接口发送请求
	- `args` [<Object\> | <string\>](###) 请求参数，当请求参数为 string 类型时，Client 内部不再执行 JSON 序列化。
	- `reqEphemeralParams` [<Object\>](###) 可指定单个请求传递的headers和请求超时时间。可选。
		- `headers` [<Object\>](###) 请求传递的头信息。可选。
		- `responseTimeout` [<number\>](###) 请求超时时间。可选，单位为 `ms`。
	:::tip
	请求的 `headers` 是不会全部做透传的。默认会传递的 `headers` 的 key 如下：（不需要调用方设置）[已使用的全链路上下文标识](http://conf.ctripcorp.com/pages/viewpage.action?pageId=192055212)
		- rootmessageid
		- currentMessageid
		- servermessageid
		- app
		- soa20-client-appid
		- x-forwarded-for
		- x-soa20-caller
		- x-ctx-* (以x-ctx-开头的)
		- x-ctrip-canary-req

	如果调用方需要传递 key 不在上述的默认 key 中，可以通过设置 `reqEphemeralParams` 来配置传递。
	:::
	- `isResHeaders` [<boolean\>](###) 设置返回值中包含 `header` 信息，默认不返回。可选。当设置`originalResponse`为`true`时，该参数无效。
	- `userId` [<string\>](###) 指定 `userId` ，可选,一般在开启单元化策略时可选择指定。
	- `isHandleServiceErrorManually` [<boolean\>](###) 默认 `false` , 当指定该值为 `true` 数据但不会做SOA格式校验。（使用场景: 报文格式为不符合SOA规范的JSON）.当设置`originalResponse`为`true`时，该参数无效。
	- `routeId`[<string\>](###) 可选，用于指定请求路由。
- Returns: [<promise\>](###)


```js
import { SoaClientAgent,CLIENT_TYPE } from '@ctrip/node-vampire-standard-soa-client‘;
SoaClientAgent({
    serviceCode: '16264',
    soaClientType:CLIENT_TYPE.WebApi
}).hello({
    args: {}
}).then((result) => {
    console.log(result);
}).catch((err) => {
    console.log(err)
});

```

## 常见问题

### 关于子环境优先原则

:::tip
- :star: 客户端访问服务时遵循子环境优先，原则如下：
	- `FWS` 的应用只能访问 `FWS` 的服务，不能访问 `FAT`、`LPT` 的服务。
	- `FAT`、`LPT` 的应用可以访问 `FWS` 的服务。
	- `FATX` 子环境的应用，优先调用相同子环境里的服务，即 `FATX`  的服务；只有当 `FATX` 找不到服务实例时，访问 `FWS` 的服务。
	- `LPTX` 子环境的应用，优先调用相同子环境的服务，即 `LPTX` 的服务；只有当 `LPTX` 找不到服务实例是，访问 `FWS` 的服务。
:::

### IP 直连时，`@ctrip/node-vampire-artemis] None Available Server Url` 异常如何解决?
- 到 [SOA Portal](http://gov.soa.fx.ctripcorp.com/) 确认对应的服务当前环境下是否有实例
- 注意上述子环境优先原则是否匹配
- [SOA Portal](http://gov.soa.fx.ctripcorp.com/) 确认该服务当前环境是否有设置：流量分配。如果配置了流量分配，需满足[路由优先级](http://conf.ctripcorp.com/pages/viewpage.action?pageId=231801327)规则。
![img_deploy3](../imgs/soaPortal.png)
