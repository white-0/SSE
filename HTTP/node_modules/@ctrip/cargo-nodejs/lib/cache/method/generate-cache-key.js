'use strict'
const is = require('is-type-of')
const md5 = require('crypto').createHash('md5')
const { KeyType } = require('../cache-config')

const PREFIX_SEPARATOR = '_'

const stringGenerator = s => {
  return String(s).toLowerCase()
}

const generateCacheKey = (key, keyType, generator = stringGenerator, isMd5 = false) => {
  const cacheKeyBuilder = []

  if (!is.function(generator)) {
    generator = stringGenerator
  }

  if (keyType !== KeyType.ORIGINAL) {
    cacheKeyBuilder.push(keyType)
    cacheKeyBuilder.push(PREFIX_SEPARATOR)
  }

  key = generator(key)

  if (isMd5) {
    cacheKeyBuilder.push(md5.update(key).digest('hex'))
  } else {
    cacheKeyBuilder.push(key)
  }

  return cacheKeyBuilder.join('')
}

module.exports = generateCacheKey
