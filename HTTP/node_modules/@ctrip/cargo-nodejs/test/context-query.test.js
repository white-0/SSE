'use strict'
const http = require('http')
const assert = require('assert')
const supertest = require('supertest')
const PORT = 3000

/**
 * @param {import('../index')} cargo
 */
module.exports = (cargo) => {

  let server, client

  it('start webserver', done => {
    /** @type {import('http').RequestListener} */
    const app = (req, res) => {
      cargo.setContextType(req, cargo.CONTEXT_TYPE.ONLINE)
      const context = cargo.getCargoContext(req, res)

      const localeAlias = context.select('LocaleAlias')
        .system()
        .locale()
        .query()

      const supportedLocales = context.select('SupportedLocale')
        .system()
        .group()
        .site()
        .queryExtendList()
        .filter(item => item.value !== '0')
        .map(item => item.locale.name)

      const topCurrencies = context.select('TopCurrency')
        .system()
        .group()
        .site()
        .queryExtendList()
        .filter(item => item.value !== '0')
        .map(item => item.currency.name)

      res.setHeader('content-type', 'application/json')
      res.end(JSON.stringify({
        localeAlias,
        supportedLocales,
        topCurrencies
      }))
    }
    server = http.createServer(app)
    server.listen(PORT)
    client = supertest(server)
    done()
  })

  it(`curl www.dev.qa.nt.tripcorp.com`, () => {
    client.get('/')
      .set('Host', 'www.dev.qa.nt.tripcorp.com')
      .expect(200)
      .end((err, res) => {
        assert.deepStrictEqual(res.body, {
          localeAlias: 'en_us,en-us,english,en,en-en,us-us,en_en,us_us,enen,enus',
          supportedLocales: ['en-US'],
          topCurrencies: ['USD', 'CNY', 'HKD', 'SGD', 'EUR']
        })
      })
  })

  it(`curl hk.dev.qa.nt.tripcorp.com?locale=en-HK`, () => {
    client.get('/?locale=en-HK')
      .set('Host', 'hk.dev.qa.nt.tripcorp.com')
      .expect(200)
      .end((err, res) => {
        assert.deepStrictEqual(res.body, {
          localeAlias: 'en_hk,en-hk,enhk,hken,en_hk,hk_en',
          supportedLocales: ['zh-HK', 'en-HK'],
          topCurrencies: ['HKD', 'TWD', 'CNY', 'USD']
        })
      })
  })

  it('stop webserver', function (done) {
    server.close(done)
  })
}
