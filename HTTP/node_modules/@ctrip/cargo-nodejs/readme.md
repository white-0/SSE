# IBU Cargo3.0 Node.js 客户端

[![pipeline status](http://git.dev.sh.ctripcorp.com/cloud-fe/cloud-cargo/badges/master/pipeline.svg)](http://git.dev.sh.ctripcorp.com/cloud-fe/cloud-cargo/commits/master)
[![coverage report](http://git.dev.sh.ctripcorp.com/cloud-fe/cloud-cargo/badges/master/coverage.svg)](http://git.dev.sh.ctripcorp.com/cloud-fe/cloud-cargo/commits/master)
`支持 Ctrip Service Mesh & AWS App Mesh`

## Install

```shell
npm i @ctrip/cargo-nodejs --registry=http://registry.npm.release.ctripcorp.com
```

## API Reference

### Cargo全局对象

#### 配置与枚举

```javascript
const cargo = require('@ctrip/cargo-nodejs')

// 日志级别枚举
// { DEBUG: 0, INFO: 1, WARNING: 2, ERROR: 3, NONE: 4 }
cargo.LOG_LEVEL

// 上下文类型枚举
// { H5: 'h5', ONLINE: 'online' }
cargo.CONTEXT_TYPE

// 初始化
cargo.init({
  appId: '',                      // 自定义appId,默认从app.config.js中取
  logLevel: cargo.LOG_LEVEL.DEBUG // 自定义日志级别,默认根据运行环境进行适配
})
```

#### 基础维度获取

```javascript
const cargo = require('@ctrip/cargo-nodejs')

// 获取Channel集合
cargo.getChannels()
// 根据channelName获取Channel对象
cargo.getChannel(channelName)
// 获取Currency集合
cargo.getCurrencies()
// 根据currencyName获取Currency对象
cargo.getCurrency(currencyName)
// 获取Group集合
cargo.getGroups()
// 根据groupName获取Group对象
cargo.getGroup(groupName)
// 获取Locale集合
cargo.getLocales()
// 根据localeName获取Locale对象
cargo.getLocale(localeName)
// 获取Source集合
cargo.getSources()
// 获取Source集
cargo.getSource(sourceName)
// 获取Site集合
cargo.getSites()
// 根据groupName+siteName获取Site对象
cargo.getSite(groupName, siteName)
// 根据groupName+siteName获取当前Site下所有合法的hos
cargo.getHosts(groupName, siteName)
// 根据host获取Site对象
cargo.getSiteByHost(host)
// 获取站点支持的币种集合
cargo.getSupportedCurrencies()
// 获取站点下的默认币种
cargo.getTopCurrencies(groupName, siteName)
// 获取Online/H5某站点下支持的语种
cargo.getSupportedLocales(contextType, groupName, siteName)
// 获取支持某个locale的所有Site信息
cargo.getLocaleSites(localeName, groupName)
// 获取支持某个locale的默认域名
cargo.getDefaultDomainByLocale(groupName, localeName, subEnv)
// 获取支持某个locale的默认站点
cargo.getDefaultSiteByLocale(groupName, localeName)
// 获取支持某个site的默认币种
cargo.getDefaultCurrencyBySite(groupName, siteName)
// 获取支持某个locale的默认币种
cargo.getDefaultCurrencyByLocale(groupName, localeName)
```

#### 币种开关配置

```javascript
// 获得产线币种开关字典
cargo.getChannelCurrencySwitchMap(channelName)
// 获得产线下某币种开关
cargo.getChannelCurrencySwitch(channelName, currencyName)
```

### 请求上下文对象

```javascript
// 手动解析cargo请求上下文
const cargoContext = cargo.getCargoContext(req, res, cargo.CONTEXT_TYPE.H5)

// get/set 上下文host
cargoContext.getHost()
cargoContext.setHost(host)

// get/set 上下文domain
cargoContext.getDomain()
cargoContext.setDomain(domain)

// get/set 上下文language
cargoContext.getLanguage()
cargoContext.setLanguage(language)

// get/set 上下文localeName
cargoContext.getLocale()
cargoContext.setLocale(locale)

// get/set 上下文currencyName
cargoContext.getCurrency()
cargoContext.setCurrency(currency)

// get/set 上下文siteName
cargoContext.getSite()
cargoContext.setSite(site)

// get/set 上下文groupName
cargoContext.getGroup()
cargoContext.setGroup(group)

// 输出上下文到 HTML data-cargo attribute
cargoContext.toHTMLAttribute() // { 'data-cargo': 'locale:en-US,language:en,currency:PLN,contextType:online,site:EN,group:Trip' }
cargoContext.toHTMLAttributeString() // 'data-cargo="locale:en-US,language:en,currency:PLN,contextType:online,site:EN,group:Trip"'

// 获取当前上下文类型
cargoContext.getContextType()

// 获取基于请求上下文的查询ContextQueryBuilder
cargoContext.select(keyName)

// 根据当前上下文设置浏览器cookie
cargoContext.setBrowserCookies()
```

### 浏览器环境 get/set 上下文

浏览器环境读取上下文时，优先从 `HTML data-cargo` 属性中读取，若没有则降级去 Cookie 中读取，部分属性依赖传入的 contextType 参数确认 `online / h5`，以便区分 cookieName 和降级策略，contextType 默认 online

在少数浏览器环境需要切换上下文的情形(Trip.com H5 不刷新切换币种)下，可以通过 SDK 提供的 set 方法设置，该方法只会更新 `HTML data-cargo` 属性，不会设置 cookie，如需更新 cookie 需要触发服务端请求设置


#### 浏览器环境引入 Cargo
```javascript
import cargo from '@ctrip/cargo-nodejs/browser'
const cargo = require('@ctrip/cargo-nodejs/browser')

// 或者目标文件无需再次打包,可以直接通过script标签引入,也支持以umd方式加载
import '@ctrip/cargo-nodejs/dist'
require('@ctrip/cargo-nodejs/dist')
```

#### 浏览器环境 Cargo API
```javascript
// get/set 上下文 locale
cargo.getLocale(contextType)
cargo.setLocale(locale)

// get/set 上下文 language
cargo.getLanguage(contextType)
cargo.setLanguage(language)

// get/set 上下文 currency
cargo.getCurrency(contextType)
cargo.setCurrency(currency)

// get/set 上下文 site
cargo.getSite()
cargo.setSite(site)

// get/set 上下文 group
cargo.getGroup()
cargo.setGroup(group)

// get/set 上下文 contextType
cargo.getContextType()
cargo.setContextType(contextType)

// 根据域名返回环境 sandbox / fws / lpt / uat / prod
cargo.getEnv()
```

### 中间件

使用中间件解析上下文后会自动挂载CargoContext对象到req.cargo(express)或ctx.cargoContext(koa)字段,并自动设置浏览器Cookie

```javascript
// 获取中间件
cargo.middlewares

// koa中间件
// CargoContext注入到ctx.cargoContext/ctx.req.cargo
cargo.middlewares.koa(cargo.CONTEXT_TYPE.H5)

// express中间件
// CargoContext注入到req.cargoContext/req.cargo
cargo.middlewares.express(cargo.CONTEXT_TYPE.ONLINE)

// 设置当前请求上下文的解析类型(h5/online)
// 需要在请求上下文环境的解析中间件前执行
cargo.setContextType(req, type)
```

运行时动态设置请求类型(online/h5)

```javascript
app.use((ctx, next) => {
  if (ctx.getUAType().isH5) {
    cargo.setContextType(ctx.req, cargo.CONTEXT_TYPE.H5)
  }
  next()
})
app.use(cargo.middlewares.koa(cargo.CONTEXT_TYPE.ONLINE))
```

### 配置查询

#### 全局查询

```javascript
// 获取全局查询QueryBuilder
cargo.select(key)

// query-builder全局查询
cargo.select(keyName)
  .system()               // 添加system()表示使用系统数据查询,否则使用当前应用下数据查询
  .group(groupName)
  .site(siteName)
  .locale(localeName)
  .currency(currencyName)
  .channel(channelName)
  .source(sourceName)
  .other(other)
  .candidate(candidate)
  .query()                // or .queryList() / .queryExtendList()
```

#### 上下文查询

```javascript
const cargoContext = cargo.getCargoContext(req, res, cargo.CONTEXT_TYPE.H5)

// 获取基于请求上下文的查询ContextQueryBuilder
cargoContext.select(keyName)

// context-query-builder上下文查询
cargoContext.select(keyName)
  .system()               // 添加system()表示使用系统数据查询,否则使用当前应用下数据查询
  .group(groupName)       // groupName为空时自动根据上下文填充
  .site(siteName)         // siteName为空时自动根据上下文填充
  .locale(localeName)     // localeName为空时自动根据上下文填充
  .currency(currencyName) // currencyName为空时自动根据上下文填充
  .channel(channelName)
  .source(sourceName)
  .other(other)
  .candidate(candidate)
  .query()                // or .queryList() / .queryExtendList()

```

#### 查询方法

```javascript
/**
 * 查询符合条件Data的value值
 * @return {string}
 */
query()

/**
 * 查询所有符合条件的Data对象列表
 * @return {Array<Data>}
 */
queryList()

/**
 * 查询所有符合条件的ExtendData对象列表,扩展Data关联的基础维度对象
 * @return {Array<ExtendedData>}
 */
queryExtendList()
```

## 接入示例

### Express

```javascript
const express = require('express')
const cargo = require('@ctrip/cargo-nodejs')
const app = express()

// 注入Cargo上下文对象CargoContext到req.cargo字段
// H5应用传入cargo.CONTEXT_TYPE.H5
// Online传入cargo.CONTEXT_TYPE.ONLINE
app.use(cargo.middlewares.express(cargo.CONTEXT_TYPE.ONLINE))

app.get('/*', (req, res) => {
  res.end(JSON.stringify({
    type: req.cargo.getContextType(),
    locale: req.cargo.getLocale(),
    currency: req.cargo.getCurrency()
  }))
})

cargo.init().then(() => {
  app.listen(3000)
})
```

### Koa

```javascript
const koa = require('koa')
const cargo = require('@ctrip/cargo-nodejs')
const app = koa()

// 如果当前应用需要同时支持H5/Online
// 可以通过前置中间件设置请求上下文类型
const setContextType = (ctx, next) => {
  cargo.setContextType(ctx.req,
    Math.random() > 0.5
    ? cargo.CONTEXT_TYPE.H5
    : cargo.CONTEXT_TYPE.ONLINE
  )
  next()
}
// 默认为H5类型
app.use(cargo.middlewares.koa(cargo.CONTEXT_TYPE.H5))

cargo.init().then(() => {
  app.listen(3000)
})
```

### 公共配置key

* googleanalytics
* seoalternate
* GoogleSiteVerification
* BaiduSiteVerification
* YandexVerification
* BingSiteVerification
* LocaleName
* LocaleIcon
* LocaleSort
* CurrencySharkKey
* CurrencyIcon
* LocaleAlias
* LocaleLanguage
* icp
* livechat
* creditcardagreement
* noticeswitch
* SiteIconUrl
* CookieDomains
* H5SiteName
* CurrencySwitch
* SupportedLocale
* TopCurrency
* H5SupportedLocale
* H5Channels
