# trip-component-ubt

## 废弃通知！！！

`@ctrip/trip-component-ubt` 从 4.1.4 版本开始将不再维护，请使用 `@ctrip/ubt-web` 替换, 详情可自行查看 [UBT 2.0](https://mpaas.ctripcorp.com/wireless_docs/mpaasdocs/docs_system/docs_platform/components/ubt/summary)


## 简介

ubt 方法的简单封装

参考: [UBT 1.0 官方文档](http://docs.ubt.ctripcorp.com/books/ubt-manual/dev-guide/js/api)

## 注意事项

`trip-component-ubt` 相关方法不支持服务端渲染，如有服务端渲染需求请在调用时自行判断环境

## api

### trackLog

TRACK：自定义数据收集

自定义数据收集，一般是“短期业务”使用此接口收集数据，数据落地后对应的 TOPIC 是 CUSTOM，可通过 HIVE 查询，一般称 tracelog 的表。

#### 接口使用流程

1. 申请自定义埋点 申请自定义埋点
2. 开发人员在部署了 UBT 采集脚本的页面上，通过调用 tacklog 接口收集数据
3. 查看自定义埋点信息及数据

#### 内置参数，value 中使用以下变量获取对应的值

- ${duid}:        加密加密用户id,
- ${page_id}:     页面page_id,
- ${is_login}:    用户是否登录

```ts
import { trackLog } from '@ctrip/trip-component-ubt';

trackLog('key', 'value').then(callback);
```

### trackMetric

TRACK: 自定义 Metric 数据接口

主要针对数值统计，如统计性能耗时、接口请求成功率等

#### 接口使用流程

1. [申请自定义埋点](https://cdataportal.ctripcorp.com/acq/register) 申请自定义埋点
2. 开发人员在部署了 UBT 采集脚本的页面上，通过调用 Metric 接口收集数据
3. [查看自定义埋点信息及数据](http://cdataportal.ctripcorp.com/acq/list)

```ts
import { trackMetric } from '@ctrip/trip-component-ubt';

interface TrackMetricOption {
  name: string; //必选 {string} metric key 需要申请
  value: number; //必选 {number} metric value 只能是数字
  tag?: Record<string, string>; //可选项,{object} Metric Tag，Tag的Key只能是字符串,tag的值长度不能超过200，数量不能超过8个
  sample?: number; //可选项,基于访客数据抽样率（百分比），默认100(全部)。 如要抽样33%，值设置为：33
}

// 提供status参数, 用于开发调试 【1：发送成功, 8: tag数量超过限制, 110 tag的值不合法
trackMetric(TrackMetricOption).then(status => {});
```

### privateTrace

GDPR TRACE 数据接口

IBU 需要对隐私数据加密处理的 tracelog 接口， 调用方式和 _tracklog 一样， 落地数据由 IBU 做加密处理后入队列

#### 声明

- tracklog 的数据是在 PV 数据回发之后发送
- tracklog 接口不适用于页面跳转的时候使用，页面跳转容易丢失数据。
- 此接口的数据是落地到 HDFS，每天凌晨 1：00 落地前一天的数据，数据归属 BI，各 BU 如需使用数据请找 BI 申请。

```ts
import { privateTrace } from '@ctrip/trip-component-ubt';

privateTrace('key', 'value');
```

### trackError

错误统计接口， 发送的数据可以在 cdataportal 上查看, 目前主要用于 JS 脚本错误。

```ts
import { trackError } from '@ctrip/trip-component-ubt';

// @see https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Error
interface ErrorData {
  line: number;
  column: number;
  file: string; //= 文件信息
  message: string;
  category?: string; //'inner-error',
  framework?: string;
  stack?: string;
  page_id?: string;
}

trackError(ErrorData);
```

### getFullPV

获取 PV 串值

值包含 vid.sid.pvid，返回的值是一个字符串，包含 VID，SID，PVID 的值， 如果要获取单个的值，建议使用 _getStatus 接口。

```ts
import { getFullPV } from '@ctrip/trip-component-ubt';

getFullPV().then((pvData: string) => {});
```

### getStatus

获取 PV 状态，包含 PV 的基本信息

```ts
import { getStatus } from '@ctrip/trip-component-ubt';

interface PVStatus {
  abtest: string; // abtest的值
  pid: number; //pageid  页面内容标识，统一在CMS系统维护，部署到页面隐藏域中。
  ps: boolean; //性能信息是否发送（performance.timing）
  pv: boolean; //pageview 是否发送
  pvid: number; //pvid  -  pageview标识
  sid: number; //sid   -  session 标识
  vid: number; //vid   -  网站用户身份标识
}

getStatus().then((status: PVStatus) => {});
```

### getFingerPrint

获取浏览器指纹接口

```ts
import { getFingerPrint } from '@ctrip/trip-component-ubt';

getFingerPrint().then((fp: string) => {});
```

### getPageId

通过调用 UBT 接口获取 Pageid 值

```ts
import { getPageId } from '@ctrip/trip-component-ubt';

getPageId().then((pageId: string) => {});
```

### asyncRefresh

TRACK：自定义 PV 接口

自定义 PV 接口，在某些特定场景，如页面的局部更新要统计 PV 数据的时候可以使用此接口

此 API 的使用会影响业务数据统计，请慎重考虑使用。

```ts
import { asyncRefresh } from '@ctrip/trip-component-ubt';

interface AsyncRefreshOption {
  page_id?: string; //可选参数，指定PV的page_id值，默认使用当前页面的page_id
  url?: string; //可选参数，指定PV的url，默认使用当前页面的URL地址
  orderid?: string; //可选参数，指定订单号
  refer?: string; //可选参数，指定refer，默认通过document.referrer获取
}

asyncRefresh(AsyncRefreshOption).then(callback);
```

### UBTRequire

加载 UBT 的模块以及个别 BU 的脚本。

```ts
import { UBTRequire } from '@ctrip/trip-component-ubt';

UBTRequire('<to-load-script-name>').then(callback);
```

## load

默认行为实在调用 ubt api 的时候加载 ubt script

支持自定义加载和延迟加载

```ts
import { lazyLoadUBTScript, loadUBTScript } from '@ctrip/trip-component-ubt';

loadUBTScript();
lazyLoadUBTScript(done => window.addEventListener('load', () => done()));
```

支持禁用自动加载

```ts
import { disableUBTScriptAutoLoad } from '@ctrip/trip-component-ubt';

disableUBTScriptAutoLoad();
```
