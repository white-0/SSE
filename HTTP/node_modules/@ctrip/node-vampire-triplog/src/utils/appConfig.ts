import frameworkFoundation from '@ctrip/node-vampire-foundation-framework';
type ff = typeof frameworkFoundation & {
    configNeedToBeUpdated: boolean
};

const bootstrap_server = {
    'fws': 'http://triplog.bootstrap.fx.fws.qa.nt.ctripcorp.com/api/bootstrap',
    'lpt': 'http://triplog.bootstrap.fx.fws.qa.nt.ctripcorp.com/api/bootstrap',
    'uat': 'http://triplog.bootstrap.fx.uat.qa.nt.ctripcorp.com/api/bootstrap',
    'pro': 'http://triplog.bootstrap.fx.ctripcorp.com/api/bootstrap',
    'pci': 'http://triplog.pci.tooling.bootstrap.fx.ctripcorp.com/api/bootstrap'
}

function getTripBootstrapServers() {
    
    return Promise.all([
        frameworkFoundation.getEnv(),
        frameworkFoundation.getConfig("*"),
      ]).then((args) => {
        let env=args[0];
        if ((frameworkFoundation as ff).configNeedToBeUpdated) {
            let url: string = args[1]["triplog.bootstrap"];
            if (url) {
                if (!url.startsWith('http')) {
                    url = 'http://' + url;
                }
                if (!url.endsWith('/')) {
                    url += '/';
                }
                return url;
            }
        }
        let url: string = frameworkFoundation.getServerPropertiesSync('pci') === 'true' ? bootstrap_server['pci'] : bootstrap_server[env];
        return url;
    }).catch(e => {
        console.log('[ @ctrip/node-vampire-triplog ] Invalid Bootstrap Host,', e);
        return Promise.reject(e);
    });
}

export default getTripBootstrapServers;