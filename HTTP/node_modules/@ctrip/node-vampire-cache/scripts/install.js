const os = require('os');
const spawn = require('child_process').spawn;

let nodeVersion = process.version.split('.')[0].slice(1);
let preBuildPath = '@ctrip/node-vampire-cache-prebuild' + nodeVersion + '-' + os.platform() + '-' + os.arch();

try {
    require.resolve(preBuildPath);
    console.log('[ PREBUILD ] PreBuild Version: ' + preBuildPath + ' is found');
} catch (e) {
    console.log('[ PREBUILD ] Missing PreBuild Version: ' + preBuildPath + ', Try Rebuild.');
    console.log('[ PREBUILD ] If the previous step failed to rebuild, try installing V18.12.1 or V16.14.0 or V14.16.0 or V12.14.1 or V10.15.1 for Node.js. If you need more information, please visit http://nodejs/ to contact us');
    runRebuild();
}

function runRebuild() {
    let proc = spawn(os.platform() == 'win32' ? 'node-gyp.cmd' : 'node-gyp', ['rebuild'], {
        stdio: 'inherit'
    });
    proc.on('exit', (code) => {
        process.exit(code);
    });
}
