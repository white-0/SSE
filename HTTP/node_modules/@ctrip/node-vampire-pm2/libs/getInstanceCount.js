var path = require('path');
var spawnSync = require('child_process').spawnSync;

var getPm2InfoScriptFile = path.resolve(__dirname, './getPm2Info.js');

function getInstancesCount (name) {
	console.log('CtripUtil PM2 Module Fork Instance Script');
	var ret = 0;
	var procOut = '';
	try {
		procOut = spawnSync(process.execPath, [getPm2InfoScriptFile, name], {
			maxBuffer: 5 * 1024 * 1024
		}).stdout.toString().trim();
	} catch (e) {}
	var json = null;
	try {
		json = JSON.parse(procOut);
	} catch (e) {};
	if (json) {
		if (json.code) {
			throw new Error(json.message);
		} else {
			ret = json.data.length;
		}
	} else {
		throw new Error('Invalid PM2 Instances');
	}
	return ret;
};

module.exports = getInstancesCount;