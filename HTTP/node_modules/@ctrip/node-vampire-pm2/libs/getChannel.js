var os = require('os');
var net = require('net');
var path = require('path');

var channel = null;
	
function getChannel (callback) {
	if (channel) {
		callback && process.nextTick(callback, channel);
	} else {
		getPort((port) => {
			var t = 'ctriputil-pm2-' + port + '.sock';
			if (os.platform() == 'win32'){
				channel = '\\\\?\\pipe\\' + t;
			} else {
				channel = path.resolve(os.tmpdir(), './' + t);
			}
			callback && callback(channel);
		});
	}
}

function getPort (callback) {
	var randomPortServer = net.createServer().listen(0, () => {
		var port = randomPortServer.address().port;
		callback && callback(port);
	});
};

module.exports = getChannel;